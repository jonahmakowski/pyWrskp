stages:
  - source_code_zip
  - github_commit
  - build_package

source_code_zip:
  image: alpine:latest
  stage: source_code_zip
  script:
    - apk add zip
    - mkdir build
    - zip -r build/source_code_$CI_COMMIT_SHA.zip src -x build
  artifacts:
    paths:
      - build/source_code_$CI_COMMIT_SHA.zip
    expire_in: 1 week

github_commit:
  image: alpine:latest
  stage: github_commit
  variables:
    GIT_DEPTH: 0
  script:
    - apk add git tar ca-certificates
    - update-ca-certificates
    - mkdir build/copy_for_github
    - tar --exclude='build' -cf - -C . . | tar -xf - -C build/copy_for_github
    - cd build/copy_for_github
    - git config user.name "GitLab CI"
    - git config user.email "jonah@makowski.ca"
    - git checkout main
    - git remote set-url origin "https://jonahmakowski:$GITHUB_PASSWORD@github.com/jonahmakowski/pyWrskp.git"
    - git config pull.rebase false
    - git pull
    - git push

build_package:
  image: python:alpine
  stage: build_package
  script:
    - cd src/helpfulPackage
    - pip install setuptools wheel
    - sh build.sh
