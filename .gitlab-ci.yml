stages:
 - notify
 - distribute

github_commit:
  image: alpine:latest
  stage: distribute
  variables:
    GIT_DEPTH: 0
  script:
    - apk add git tar ca-certificates
    - update-ca-certificates
    - mkdir -p build/copy_for_github
    - tar --exclude='build' -cf - -C . . | tar -xf - -C build/copy_for_github
    - cd build/copy_for_github
    - git config user.name "GitLab CI"
    - git config user.email "jonah@makowski.ca"
    - git checkout main
    - git remote set-url origin "https://jonahmakowski:$GITHUB_PASSWORD@github.com/jonahmakowski/pyWrskp.git"
    - git config pull.rebase false
    - git pull
    - git push

discord_notify:
  stage: notify
  script:
    - |
      curl -H "Content-Type: application/json" -X POST -d '{
        "embeds": [{
          "title": "ðŸš€ GitLab CI/CD Pipeline Update",
          "description": "**Project:** ${CI_PROJECT_NAME}\n**${CI_COMMIT_TITLE}**\n${CI_COMMIT_DESCRIPTION}\n\n\t-${CI_COMMIT_AUTHOR}",
          "color": 16776960
        }]
      }' $DISCORD_WEBHOOK

build_package:
  image: python:alpine
  stage: distribute
  variables:
    TWINE_USERNAME: gitlab-ci-token
    TWINE_PASSWORD: $CI_JOB_TOKEN
  script:
    - cd src/helpfulPackage
    - pip install --upgrade pip
    - pip install setuptools wheel
    - python setup.py bdist_wheel sdist
    - pip install .[dev]
    - twine check dist/*
    - twine upload --repository-url ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/pypi dist/*
  only:
    changes:
      - src/helpfulPackage/setup.py
  artifacts:
    paths:
      - src/helpfulPackage/dist
    expire_in: 1 day
